<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IoT GPIO Dashboard (Pi + ESP32)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#0f172a; color:#f8fafc; text-align:center; margin:0; padding:0; }
  h1 { color:#38bdf8; margin:20px 0; }
  .status { padding:10px; margin:10px; border-radius:8px; font-weight:bold; display:inline-block; }
  .connected { background:#10b981; }
  .disconnected { background:#ef4444; }
  .container { display:flex; flex-wrap:wrap; justify-content:center; gap:20px; margin:20px; }
  .device-card { background:#1e293b; border-radius:12px; padding:20px; width:250px; box-shadow:0 4px 10px rgba(0,0,0,0.4); }
  .device-title { font-weight:bold; color:#fbbf24; margin-bottom:10px; }
  .pin { display:flex; justify-content:space-between; background:#334155; padding:8px; border-radius:6px; margin:5px 0; }
  button { padding:5px 10px; border:none; border-radius:6px; cursor:pointer; color:#fff; }
  .on { background:#10b981; }
  .off { background:#ef4444; }
  .logs { background:#1e293b; padding:10px; border-radius:8px; margin:20px; max-height:200px; overflow-y:auto; font-family:monospace; font-size:12px; text-align:left; }
</style>
</head>
<body>

<h1>üåê IoT GPIO Dashboard</h1>
<div id="connectionStatus" class="status disconnected">‚ùå Disconnected</div>

<div class="container" id="devicesContainer"></div>

<h2>üìã Logs</h2>
<div class="logs" id="logs"></div>

<script>
// ---------- CONFIG ----------
const BROKER_URL = "ws://13.234.21.33:9001"; // AWS MQTT WebSocket
const TOPIC_CONTROL = "myiot/device/control";
const TOPIC_STATUS  = "myiot/device/status";

const devicesContainer = document.getElementById("devicesContainer");
const logsEl = document.getElementById("logs");
const statusEl = document.getElementById("connectionStatus");

let devices = {}; // store all devices states

function log(message) {
  const entry = document.createElement("div");
  entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  logsEl.prepend(entry);
  if (logsEl.children.length > 50) logsEl.removeChild(logsEl.lastChild);
}

function setStatus(connected) {
  statusEl.textContent = connected ? "‚úÖ Connected" : "‚ùå Disconnected";
  statusEl.className = connected ? "status connected" : "status disconnected";
}

// ---------- Render a device card ----------
function renderDevice(device_id, pins) {
  let card = document.getElementById(`device-${device_id}`);
  if (!card) {
    card = document.createElement("div");
    card.id = `device-${device_id}`;
    card.className = "device-card";
    devicesContainer.appendChild(card);
  }

  let html = `<div class="device-title">${device_id}</div>`;
  for (const [pin, state] of Object.entries(pins)) {
    html += `<div class="pin">
      <span>GPIO ${pin}</span>
      <button class="${state?"on":"off"}" onclick="togglePin('${device_id}', ${pin}, ${!state})">${state?"ON":"OFF"}</button>
    </div>`;
  }
  card.innerHTML = html;
}

// ---------- Send control command ----------
function togglePin(device_id, pin, turnOn) {
  const payload = { device_id, pin, command: turnOn ? "ON" : "OFF" };
  client.publish(TOPIC_CONTROL, JSON.stringify(payload), { qos:1 });
  log(`Sent command: ${JSON.stringify(payload)}`);
}

// ---------- MQTT Client ----------
let client = mqtt.connect(BROKER_URL, {
  clientId: "WebDashboard_" + Math.random().toString(16).substr(2,8),
  reconnectPeriod: 5000
});

client.on("connect", () => {
  log("‚úÖ Connected to MQTT broker");
  setStatus(true);
  client.subscribe(TOPIC_STATUS, { qos:1 });
});

client.on("reconnect", () => log("üîÅ Reconnecting..."));
client.on("close", () => { log("üîå Connection closed"); setStatus(false); });
client.on("offline", () => setStatus(false));
client.on("error", (err) => log("‚ùå MQTT error: " + err.message));

client.on("message", (topic, message) => {
  if (topic === TOPIC_STATUS) {
    try {
      const data = JSON.parse(message.toString());
      devices[data.device_id] = data.pins;
      renderDevice(data.device_id, data.pins);
      log(`Received state from ${data.device_id}`);
    } catch(e) {
      log("‚ùå Error parsing message: " + e.message);
    }
  }
});
</script>
</body>
</html>
